<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>POS PDF → Dashboard</title>

<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>

<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
  h1 { margin: 0 0 12px; }
  input[type="file"] { margin: 8px 0 16px; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 14px; }
  th { background: #f5f5f5; text-align: left; }
  .section { margin-top: 24px; display: none; }
  .muted { color: #666; font-size: 13px; }
</style>
</head>
<body>
<h1>POS PDF → Live Dashboard</h1>
<input type="file" id="pdfFile" accept="application/pdf" />
<div id="status" class="muted"></div>

<div id="employeeSummary" class="section">
  <h2>Employee Summary</h2>
  <table>
    <thead>
      <tr>
        <th>Drawer ID</th><th>Employee</th><th>Total</th>
        <th>Cash</th><th>Visa</th><th>Master</th><th>AmEx</th><th>Short</th>
      </tr>
    </thead>
    <tbody id="empRows"></tbody>
  </table>
</div>

<div id="drawerSummary" class="section">
  <h2>Drawer Summary</h2>
  <table>
    <thead>
      <tr>
        <th>Drawer</th><th>Opened</th><th>Closed</th>
        <th>Cash</th><th>Visa</th><th>Master</th><th>AmEx</th><th>Total</th>
      </tr>
    </thead>
    <tbody id="drawerRows"></tbody>
  </table>
</div>

<div id="hourlySales" class="section">
  <h2>Hourly Sales</h2>
  <table>
    <thead>
      <tr><th>Time</th><th>Sales</th><th>Receipts</th><th>Trans</th></tr>
    </thead>
    <tbody id="hourlyRows"></tbody>
  </table>
</div>

<script>
(function ensureWorker() {
  // Avoid worker warnings in some setups
  if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.worker.min.js";
  }
})();

const $ = (id) => document.getElementById(id);
const statusEl = $("status");

function money(v){
  if (v === null || v === undefined || Number.isNaN(Number(v))) return "—";
  const n = Number(v);
  return n.toLocaleString(undefined, { style: "currency", currency: "USD" });
}
function num(s){
  const m = String(s).match(/-?\d+(?:,\d{3})*(?:\.\d+)?/);
  if (!m) return 0;
  return parseFloat(m[0].replace(/,/g, "")) || 0;
}

function parseReport(text){
  const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);
  const joined = lines.join("\n");

  // ---------------- Employee Summary (by employee)
  const employees = [];
  const empIdx = lines.findIndex(l => /Employee Summary/i.test(l));
  if (empIdx !== -1) {
    const stopIdx = [
      lines.findIndex((l,i)=> i>empIdx && /(Hourly Sales|Activity By Hour|Merchandise (Department )?Summary|Total All Drawers|Cash Drawer ID|Other Statistics|Report Totals)/i.test(l))
    ].filter(x => x !== -1).sort((a,b)=>a-b)[0] || lines.length;
    const seg = lines.slice(empIdx+1, stopIdx);

    for (let i = 0; i < seg.length; i++) {
      let drawerId = null, name = null;

      // drawer id like "#1" or "1"
      if (/^#?\d+$/.test(seg[i])) { drawerId = seg[i].replace("#",""); i++; }

      // next non-numeric token is the name
      if (i < seg.length && !/^-?\d+(?:,\d{3})*(?:\.\d+)?$/.test(seg[i])) {
        name = seg[i];
        i++;
      }

      // collect up to 6 numbers: total,cash,visa,master,amex,short
      const vals = [];
      while (i < seg.length && vals.length < 6 && /^-?\d+(?:,\d{3})*(?:\.\d+)?$/.test(seg[i])) {
        vals.push(num(seg[i]));
        i++;
      }
      if (vals.length >= 1 || name) {
        const [total,cash,visa,master,amex,short_] = vals.concat(Array(6-vals.length).fill(0));
        employees.push({ drawerId, name, total, cash, visa, master, amex, short: short_ });
      }
      i--; // align for loop
    }
  }

  // ---------------- Drawer Summary (by drawer)
  const drawers = [];
  for (let i=0;i<lines.length;i++){
    const m = lines[i].match(/Cash Drawer ID\s*(\d+)/i);
    if (!m) continue;
    const id = m[1];

    // look ahead (bounded) until next drawer/total
    const end = (()=>{
      for (let k=i+1;k<Math.min(i+80,lines.length);k++){
        if (/Cash Drawer ID\s*\d+/i.test(lines[k]) || /Total All Drawers/i.test(lines[k])) return k;
      }
      return Math.min(i+80,lines.length);
    })();
    const seg = lines.slice(i+1, end);

    const pick = (label)=>{
      const idx = seg.findIndex(s => new RegExp("^"+label+":?$","i").test(s));
      if (idx === -1) return null;
      for (let j=1;j<=4 && (idx+j)<seg.length;j++){
        // numeric
        if (/^-?\d+(?:,\d{3})*(?:\.\d+)?$/.test(seg[idx+j])) return num(seg[idx+j]);
        // time/date-ish strings
        if (/^\d{1,2}:\d{2}/.test(seg[idx+j]) || /[-/]\d{2,4}/.test(seg[idx+j])) return seg[idx+j];
      }
      return null;
    };

    const opened = pick("Opened");
    const closed = pick("Closed");
    const cash   = pick("Cash")   ?? 0;
    const visa   = pick("Visa")   ?? 0;
    const master = pick("Master") ?? 0;
    const amex   = pick("AmEx")   ?? 0;
    const total  = pick("Total")  ?? (cash + visa + master + amex);
    drawers.push({ id, opened, closed, cash, visa, master, amex, total });
  }

  // ---------------- Hourly Sales / Activity By Hour (robust)
  // Accept either header label
  const hours = [];
  const hourHeaderIdx = lines.findIndex(l => /^(Hourly Sales|Activity By Hour)$/i.test(l));
  if (hourHeaderIdx !== -1) {
    const stopIdx = [
      lines.findIndex((l,i)=> i>hourHeaderIdx && /(Other Statistics|Employee Summary|Merchandise (Department )?Summary|Total All Drawers|Cash Drawer ID|Report Totals)/i.test(l))
    ].filter(x=>x!==-1).sort((a,b)=>a-b)[0] || lines.length;
    const seg = lines.slice(hourHeaderIdx+1, stopIdx);

    // time range pattern examples:
    // "11am - 12pm", "11:00 am–12:00 pm", "11 am to 12 pm"
    const timeRe = /(\d{1,2}(?::\d{2})?\s*(?:am|pm))\s*(?:-|–|to)\s*(\d{1,2}(?::\d{2})?\s*(?:am|pm))/ig;

    for (let k = 0; k < seg.length; k++) {
      const line = seg[k];
      const matches = [...line.matchAll(timeRe)];
      if (matches.length === 0) continue;

      for (const m of matches) {
        const label = `${m[1].replace(/\s+/g,'')} – ${m[2].replace(/\s+/g,'')}`;
        const nums = [];

        // 1) numbers on same line after the match
        const tail = line.slice(m.index + m[0].length);
        const same = tail.match(/-?\d+(?:,\d{3})*(?:\.\d+)?/g) || [];
        same.forEach(v => { if (nums.length < 3) nums.push(num(v)); });

        // 2) if fewer than 3, scan following lines until next time header
        let j = k + 1;
        while (nums.length < 3 && j < seg.length) {
          if (timeRe.test(seg[j])) { timeRe.lastIndex = 0; break; }
          const more = seg[j].match(/-?\d+(?:,\d{3})*(?:\.\d+)?/g) || [];
          more.forEach(v => { if (nums.length < 3) nums.push(num(v)); });
          j++;
        }

        hours.push({
          time: label,
          sales: nums[0] ?? 0,
          receipts: Number.isFinite(nums[1]) ? nums[1] : null,
          trans: Number.isFinite(nums[2]) ? nums[2] : null
        });
      }
    }
  }

  return { employees, drawers, hours };
}

function render(r){
  // Employees
  if (r.employees.length){
    $("employeeSummary").style.display='block';
    const tbody = $("empRows"); tbody.innerHTML = '';
    r.employees.forEach(e=>{
      const tr=document.createElement('tr');
      tr.innerHTML =
        `<td>${e.drawerId ?? ""}</td><td>${e.name ?? ""}</td>
         <td>${money(e.total)}</td><td>${money(e.cash)}</td>
         <td>${money(e.visa)}</td><td>${money(e.master)}</td>
         <td>${money(e.amex)}</td><td>${money(e.short)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Drawers
  if (r.drawers.length){
    $("drawerSummary").style.display='block';
    const tbody = $("drawerRows"); tbody.innerHTML = '';
    r.drawers.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML =
        `<td>#${d.id}</td><td>${d.opened ?? ""}</td><td>${d.closed ?? ""}</td>
         <td>${money(d.cash)}</td><td>${money(d.visa)}</td>
         <td>${money(d.master)}</td><td>${money(d.amex)}</td>
         <td>${money(d.total)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Hourly
  if (r.hours.length){
    $("hourlySales").style.display='block';
    const tbody = $("hourlyRows"); tbody.innerHTML = '';
    r.hours.forEach(h=>{
      const tr=document.createElement('tr');
      const intOrDash = (v)=> (v===null||v===undefined||Number.isNaN(v)) ? "—" : Number(v).toLocaleString();
      tr.innerHTML =
        `<td>${h.time}</td><td>${money(h.sales)}</td>
         <td>${intOrDash(h.receipts)}</td><td>${intOrDash(h.trans)}</td>`;
      tbody.appendChild(tr);
    });
  }
}

// ------- File → PDF text → parse → render
$("pdfFile").addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if (!file) return;

  statusEl.textContent = "Loading PDF…";
  try {
    // wait for pdfjs to be ready
    await new Promise((res, rej) => {
      const start = performance.now();
      (function tick(){
        if (window.pdfjsLib) return res();
        if (performance.now() - start > 12000) return rej(new Error("pdf.js failed to load"));
        setTimeout(tick, 50);
      })();
    });

    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

    let text = "";
    for (let p=1; p<=pdf.numPages; p++){
      statusEl.textContent = `Reading page ${p}/${pdf.numPages}…`;
      const page = await pdf.getPage(p);
      const content = await page.getTextContent({ normalizeWhitespace: true });
      text += content.items.map(it => it?.str || "").join("\n") + "\n";
      await new Promise(r => setTimeout(r, 0)); // let UI update
    }

    statusEl.textContent = "Parsing…";
    const report = parseReport(text);
    statusEl.textContent = "Rendering…";
    render(report);
    statusEl.textContent = "Done.";
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Failed to read this PDF. Check the console for details.";
  }
});
</script>
</body>
</html>
